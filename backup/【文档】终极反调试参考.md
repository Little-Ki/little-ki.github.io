原文：The Ultimate Anti-Debugging Reference

# 1.NtGlobalFlag

**NtGlobalFlag** 是 Process Environment Block (PEB) 的一个字段，位于 PEB + 0x68 (32位) / 0xBC (64位) 处，该值为零，在附加调试器时不会更改但在过程控制下可能会更改，由调试器创建的进程将有以下值：

> FLG_HEAP_ENABLE_TAIL_CHECK (0x10)
> FLG_HEAP_ENABLE_FREE_CHECK (0x20)
> FLG_HEAP_VALIDATE_PARAMETERS (0x40)

可通过此方法检查：

```asm
; 32位
mov eax, fs:[30h] ; Process Environment Block
mov al, [eax+68h] ; NtGlobalFlag
and al, 70h
cmp al, 70h
je being_debugged

; 64位
push 60h
pop rsi
gs:lodsq ;Process Environment Block
mov al, [rsi*2+rax-14h] ;NtGlobalFlag
and al, 70h
cmp al, 70h
je being_debugged
```

# 2.Heap Flags
堆包含两个与NtGlobalFlag一起初始化的标志，分别为 **Flags** 和 **ForceFlags**。
Flags 在堆上具有以下偏移量：
|版本|偏移|
|:-:|:-:|
|Windows NT/2000/XP (x86)|0x0C|
|>= Windows Vista (x86)|0x40|
|Windows XP (x64)|0x14|
|>= Windows Vista (x64)|0x70|

ForceFlags 在堆上具有以下偏移量：
|版本|偏移|
|:-:|:-:|
|Windows NT/2000/XP (x86)|0x10|
|>= Windows Vista (x86)|0x44|
|Windows XP (x64)|0x18|
|>= Windows Vista (x64)|0x74|

在所有版本系统上，Flags 值通常为 HEAP_GROWABLE（2），ForceFlags 值通常为0，对于32位进程，值取决于主机进程的子系统版本，仅当子系统版本为 3.51 或更高版本时，字段值才如上所述。如果子系统版本为 3.10-3.50，则还将在两个字段中设置 HEAP_CREATE_ALIGN_16（0x10000） 标志。 如果子系统版本低于 3.10，则文件将根本不运行。

当存在调试器时，Flags 字段通常设置为以下标志的组合
> **Windows NT、Windows 2000 和 32 位 Windows XP**
> HEAP_GROWABLE（2）
> HEAP_TAIL_CHECKING_ENABLED（0x20）
> HEAP_FREE_CHECKING_ENABLED（0x40） 
> HEAP_SKIP_VALIDATION_CHECKS（0x10000000）
> HEAP_VALIDATE_PARAMETERS_ENABLED （0x40000000）

> **在 64 位 Windows XP 和 Windows Vista 及更高版本上**
> HEAP_GROWABLE (2)
> HEAP_TAIL_CHECKING_ENABLED (0x20)
> HEAP_FREE_CHECKING_ENABLED (0x40)
> HEAP_VALIDATE_PARAMETERS_ENABLED (0x40000000)

当存在调试器时，ForceFlags 字段通常设置为以下标志的组合
> HEAP_TAIL_CHECKING_ENABLED (0x20)
> HEAP_FREE_CHECKING_ENABLED (0x40)
> HEAP_VALIDATE_PARAMETERS_ENABLED (0x40000000)

若 NtGlobalFlag 具有 FLG_HEAP_ENABLE_TAIL_CHECK，则堆字段具有 HEAP_TAIL_CHECKING_ENABLED。
若 NtGlobalFlag 具有 FLG_HEAP_ENABLE_FREE_CHECK，则堆字段具有 HEAP_FREE_CHECKING_ENABLED。
若 NtGlobalFlag 具有 FLG_HEAP_VALIDATE_PARAMETERS，则堆字段具有 HEAP_VALIDATE_PARAMETERS_ENABLED / HEAP_CREATE_ALIGN_16。

使用此方式检查堆的位置：

```asm
; 32位
mov eax, fs:[30h] ;Process Environment Block
mov eax, [eax+18h] ;get process heap base

; 64位
push 60h
pop rsi
gs:lodsq ;Process Environment Block
mov eax, [rax+30h] ;get process heap base
```